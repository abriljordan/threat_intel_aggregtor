{% extends "base.html" %}

{% block title %}Dashboard - Threat Intelligence{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
        color: white;
    }
    
    .stat-card .icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1rem;
    }
    
    .api-status {
        padding: 0.5rem;
        border-radius: 5px;
        margin-bottom: 0.5rem;
    }
    
    .api-status.online {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
    }
    
    .api-status.offline {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Quick Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Search</h5>
                    <form id="quickSearchForm" class="row g-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Enter IP address or domain" required>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="apiSelect">
                                <option value="all">All APIs</option>
                                <option value="abuseipdb">AbuseIPDB</option>
                                <option value="virustotal">VirusTotal</option>
                                <option value="shodan">Shodan</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Total Checks</h6>
                            <h2 class="card-title mb-0" id="totalChecks">0</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Malicious IPs</h6>
                            <h2 class="card-title mb-0" id="maliciousIPs">0</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-skull-crossbones"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Total Reports</h6>
                            <h2 class="card-title mb-0" id="totalReports">0</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">API Status</h6>
                            <h2 class="card-title mb-0" id="apiStatus">Online</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-plug"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Results -->
    <div class="row">
        <!-- Threat Distribution Chart -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Threat Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="threatChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div id="recentActivity" class="list-group">
                        <!-- Activity items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Search Results</h5>
                </div>
                <div class="card-body">
                    <div id="searchResults">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize charts
    const threatChart = new Chart(document.getElementById('threatChart'), {
        type: 'doughnut',
        data: {
            labels: ['Malicious', 'Suspicious', 'Clean'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(46, 204, 113, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Handle quick search form submission
    document.getElementById('quickSearchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const target = document.getElementById('searchInput').value;
        const api = document.getElementById('apiSelect').value;
        
        try {
            const response = await fetch(`/api/check/${target}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apis: api === 'all' ? ['all'] : [api]
                })
            });
            
            const results = await response.json();
            displayResults(results);
            
            // Add to recent activity
            addRecentActivity(target, api);
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error performing search', 'danger');
        }
    });

    // Display search results
    function displayResults(results) {
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';
        
        for (const [api, data] of Object.entries(results)) {
            if (data.error) {
                resultsDiv.innerHTML += `
                    <div class="alert alert-danger">
                        <h6>${api.toUpperCase()} Error</h6>
                        <p>${data.error}</p>
                    </div>
                `;
                continue;
            }
            
            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.innerHTML = `
                <div class="card-header">
                    <h6 class="mb-0">${api.toUpperCase()} Results</h6>
                </div>
                <div class="card-body">
                    <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            resultsDiv.appendChild(card);
        }
    }

    // Add recent activity
    function addRecentActivity(target, api) {
        const activityDiv = document.getElementById('recentActivity');
        const now = new Date().toLocaleTimeString();
        
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">Checked ${target}</h6>
                <small>${now}</small>
            </div>
            <p class="mb-1">Using ${api === 'all' ? 'all APIs' : api}</p>
        `;
        
        activityDiv.insertBefore(item, activityDiv.firstChild);
        
        // Keep only last 5 activities
        while (activityDiv.children.length > 5) {
            activityDiv.removeChild(activityDiv.lastChild);
        }
    }

    // Show alert message
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(
            alertDiv,
            document.querySelector('.row')
        );
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Update stats periodically
    function updateStats() {
        // This would typically fetch real stats from the backend
        document.getElementById('totalChecks').textContent = 
            Math.floor(Math.random() * 1000);
        document.getElementById('maliciousIPs').textContent = 
            Math.floor(Math.random() * 100);
        document.getElementById('totalReports').textContent = 
            Math.floor(Math.random() * 500);
    }

    // Initial stats update
    updateStats();
    
    // Update stats every 30 seconds
    setInterval(updateStats, 30000);
</script>
{% endblock %}
